<div class="files-container p-4 fade-in">
    <!-- Header & Search -->
    <div class="flex justify-content-between align-items-center mb-4">
        <h1 class="text-3xl font-bold mb-1 title-section"><i class="fas fa-folder-tree me-2"></i>Files</h1>

        <div class="search-box">
            <ad-input icon="fa-solid fa-search" placeholder="Search folders or files..."
                (inputChange)="onSearch($event)">
            </ad-input>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <div class="mb-4 flex align-items-center gap-2 text-600" *ngIf="currentView === 'year'">
        <span class="cursor-pointer hover:text-primary transition-colors" (click)="goBackToRoot()">Files</span>
        <i class="fa-solid fa-chevron-right text-xs"></i>
        <span class="font-bold text-primary">{{ selectedYearFolder?.year }}</span>
    </div>

    <!-- User File Template Component -->
    <app-user-file-template (templateStatus)="onTemplateStatusChange($event)" (onViewDetails)="onViewDetails($event)"
        (onUploadTemplate)="selectCreateTemplate()">
    </app-user-file-template>

    <!-- Custom Loader Overlay -->
    <div *ngIf="isUploadingTemplate"
        class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 z-5 flex flex-column align-items-center justify-content-center fade-in">
        <div class="surface-card p-5 border-round-xl shadow-4 flex flex-column align-items-center gap-4"
            style="min-width: 300px;">
            <div class="relative w-6rem h-6rem">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="50%" cy="50%" r="40%" fill="none" class="stroke-200 stroke-2" />
                    <circle cx="50%" cy="50%" r="40%" fill="none"
                        class="stroke-primary stroke-4 transition-all duration-500" [style.stroke-dasharray]="'251.2'"
                        [style.stroke-dashoffset]="251.2 * (1 - uploadProgress / 100)" stroke-linecap="round" />
                </svg>
                <div class="absolute top-0 left-0 w-full h-full flex align-items-center justify-content-center">
                    <span class="text-xl font-bold text-primary">{{uploadProgress}}%</span>
                </div>
            </div>

            <div class="flex flex-column align-items-center gap-2">
                <span class="font-bold text-xl text-800">Analisi Template in corso...</span>
                <span class="text-600 text-sm text-center">Stiamo analizzando la tua busta paga.<br>L'operazione
                    potrebbe richiedere qualche secondo.</span>
            </div>
        </div>
    </div>

    <!-- Empty State (Root) -->
    <div *ngIf="currentView === 'root' && filteredFolders.length === 0 && !searchQuery"
        class="empty-state flex flex-column align-items-center justify-content-center h-20rem border-2 border-dashed border-300 border-round-xl bg-white-alpha-50 cursor-pointer hover:bg-white-alpha-80 transition-all"
        (click)="openCreateChoiceDialog()">
        <div
            class="icon-circle bg-primary-50 text-primary border-circle w-4rem h-4rem flex align-items-center justify-content-center mb-3">
            <i class="fa-solid fa-plus text-2xl"></i>
        </div>
        <h3 class="m-0 text-700">No Pay Slips Yet</h3>
        <p class="text-500 mt-2">Click to add your first content</p>
    </div>

    <!-- Root View: Year Folders Grid -->
    <div *ngIf="currentView === 'root' && (filteredFolders.length > 0 || searchQuery)" class="grid">
        <!-- Add / Upload Card (Combined) -->
        <div class="col-12 sm:col-6 md:col-4 lg:col-3">
            <ad-card padding="large" borderRadius="xl" [border]="true" [clickable]="true"
                styleClass="folder-card create-card h-full flex flex-column align-items-center justify-content-center border-dashed hover:surface-50 text-center"
                (onClick)="openCreateChoiceDialog()">
                <div class="flex flex-column align-items-center">
                    <i class="fa-solid fa-plus text-3xl text-400 mb-2"></i>
                    <span class="text-600 font-medium">Add New</span>
                </div>
            </ad-card>
        </div>

        <!-- Pending Uploads Card -->


        <!-- Year Folders -->
        <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let folder of filteredFolders">
            <ad-card padding="large" shadow="medium" borderRadius="xl" [border]="true" [hoverable]="true"
                [clickable]="true" [colorStrip]="folder.color" styleClass="folder-card h-full"
                (onClick)="openYearFolder(folder)">
                <div class="flex align-items-center justify-content-between mb-3">
                    <i class="fa-solid fa-folder text-4xl" [style.color]="folder.color"></i>
                    <span class="text-500 text-sm">{{ folder.months.length }} months</span>
                </div>
                <h3 class="text-xl font-bold text-800 m-0">{{ folder.year }}</h3>
            </ad-card>
        </div>
    </div>

    <!-- Year View: Month Folders Grid -->
    <div *ngIf="currentView === 'year' && selectedYearFolder" class="grid">
        <!-- Add New Month Card -->
        <div class="col-12 sm:col-6 md:col-4 lg:col-3">
            <ad-card padding="large" borderRadius="xl" [border]="true" [clickable]="true"
                styleClass="folder-card create-card h-full flex flex-column align-items-center justify-content-center border-dashed hover:surface-50"
                (onClick)="openCreateMonthDialog()">
                <i class="fa-solid fa-plus text-3xl text-400 mb-2"></i>
                <span class="text-600 font-medium">New Month Folder</span>
            </ad-card>
        </div>

        <!-- Month Folders -->
        <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let month of displayedMonths">
            <ad-card padding="large" shadow="medium" borderRadius="xl" [border]="true" [hoverable]="true"
                styleClass="folder-card h-full">
                <div class="flex align-items-center justify-content-between mb-3">
                    <i class="fa-regular fa-folder-open text-4xl text-primary"></i>
                    <span class="badge bg-primary-50 text-primary border-round px-2 py-1 text-xs font-bold"
                        *ngIf="month.files.length > 0">
                        PDF
                    </span>
                </div>
                <h3 class="text-lg font-bold text-800 m-0 mb-2">{{ month.name }}</h3>

                <!-- File Preview (if exists) -->
                <div *ngIf="month.files.length > 0"
                    class="file-preview flex align-items-center gap-2 p-2 surface-50 border-round">
                    <i class="fa-solid fa-file-pdf text-red-500"></i>
                    <span class="text-xs text-600 white-space-nowrap overflow-hidden text-overflow-ellipsis">{{
                        month.files[0].name }}</span>
                </div>
                <div *ngIf="month.files.length === 0" class="text-xs text-400 italic">
                    No files yet
                </div>
            </ad-card>
        </div>
    </div>
</div>

<!-- Create Year Dialog -->
<ad-dialog [(visible)]="showYearDialog" header="Create Year Folder" [style]="{width: '400px'}">

    <div class="flex flex-column gap-3">
        <ad-year-picker label="Year" [(year)]="newYearData.year">
        </ad-year-picker>

        <ad-color-picker label="Folder Color" [(color)]="newYearData.color">
        </ad-color-picker>

        <ad-fileuploader label="Upload Payslip (Optional)" accept=".pdf" mode="basic"
            (onSelect)="onYearFileSelect($event)">
        </ad-fileuploader>

        <div class="flex justify-content-end gap-2 mt-2">
            <ad-button label="Cancel" severity="secondary" (onClick)="showYearDialog = false"></ad-button>
            <ad-button label="Create" (onClick)="createYear()"></ad-button>
        </div>
    </div>
</ad-dialog>

<!-- Choice Dialog -->
<ad-dialog [(visible)]="showChoiceDialog" header="Crea o Carica" [style]="{width: '400px'}">
    <div class="flex flex-column gap-3">
        <!-- Create Folder ATTUALMENTE DISABILITATO -->
        <!-- <div class="p-4 border-1 border-200 border-round cursor-pointer hover:surface-50 transition-colors flex align-items-center gap-3"
            (click)="selectCreateFolder()">
            <div
                class="bg-primary-50 text-primary border-circle w-3rem h-3rem flex align-items-center justify-content-center">
                <i class="fa-solid fa-folder-plus text-xl"></i>
            </div>
            <div class="flex flex-column">
                <span class="font-bold text-700">Crea una cartella</span>
                <span class="text-sm text-500">Crea manualmente una nuova cartella anno</span>
            </div>
        </div> -->

        <div class="p-4 border-1 border-200 border-round cursor-pointer transition-colors flex align-items-center gap-3"
            [ngClass]="{'opacity-50 pointer-events-none bg-gray-50': !templateExists, 'hover:surface-50': templateExists}"
            (click)="selectUploadDocuments()">
            <div class="bg-green-50 text-green-500 border-circle w-3rem h-3rem flex align-items-center justify-content-center"
                [ngClass]="{'grayscale': !templateExists}">
                <i class="fa-solid fa-file-arrow-up text-xl"></i>
            </div>
            <div class="flex flex-column">
                <span class="font-bold text-700">Carica i tuoi documenti</span>
                <span class="text-sm text-500" *ngIf="templateExists">Carica le tue buste paga PDF</span>
                <span class="text-sm text-red-500" *ngIf="!templateExists">Richiede Template</span>
            </div>
        </div>

        <div *ngIf="!templateExists"
            class="p-4 border-1 border-200 border-round cursor-pointer hover:surface-50 transition-colors flex align-items-center gap-3"
            (click)="selectCreateTemplate()">
            <div
                class="bg-purple-50 text-purple-500 border-circle w-3rem h-3rem flex align-items-center justify-content-center">
                <i class="fa-solid fa-file-invoice text-xl"></i>
            </div>
            <div class="flex flex-column">
                <span class="font-bold text-700">Crea il template della busta paga</span>
                <span class="text-sm text-500">Genera template da PDF</span>
            </div>
        </div>
    </div>
</ad-dialog>

<!-- Create Month Dialog -->
<ad-dialog [(visible)]="showMonthDialog" header="Create Month Folder" [style]="{width: '400px'}">

    <div class="flex flex-column gap-3">
        <ad-month-picker label="Month" [(month)]="newMonthData.month">
        </ad-month-picker>

        <ad-fileuploader label="Upload Payslip" accept=".pdf" mode="basic" (onSelect)="onMonthFileSelect($event)">
        </ad-fileuploader>

        <div class="flex justify-content-end gap-2 mt-2">
            <ad-button label="Cancel" severity="secondary" (onClick)="showMonthDialog = false"></ad-button>
            <ad-button label="Create" (onClick)="createMonth()"></ad-button>
        </div>
    </div>
</ad-dialog>

<!-- Upload Documents Dialog -->
<ad-dialog [(visible)]="showUploadDialog" header="Carica Documenti" [style]="{width: '500px'}">
    <!-- Hidden Input inside dialog -->
    <input type="file" id="payslipInput" multiple accept=".pdf" style="display: none"
        (change)="onPayslipsSelected($event)">

    <div class="flex flex-column gap-3">
        <div class="upload-drop-zone border-2 border-dashed border-300 border-round-xl surface-50 p-5 flex flex-column align-items-center justify-content-center cursor-pointer hover:surface-100 transition-colors"
            (click)="triggerPayslipInput()" (drop)="onFileDrop($event)" (dragover)="onDragOver($event)">

            <i class="fa-solid fa-cloud-arrow-up text-5xl text-400 mb-3"></i>
            <h3 class="m-0 text-700">Trascina qui i tuoi file</h3>
            <p class="text-500 mb-3">o clicca per selezionarli</p>
            <span class="text-xs text-400">Solo file PDF</span>
        </div>

        <!-- Preview List -->
        <div *ngIf="payslipFiles.length > 0" class="flex flex-column gap-2 max-h-15rem overflow-y-auto">
            <div *ngFor="let file of payslipFiles; let i = index"
                class="flex align-items-center justify-content-between p-2 surface-100 border-round">
                <div class="flex align-items-center gap-2 overflow-hidden">
                    <i class="fa-solid fa-file-pdf text-red-500"></i>
                    <span class="text-sm text-700 white-space-nowrap overflow-hidden text-overflow-ellipsis">{{
                        file.name }}</span>
                </div>
                <i class="fa-solid fa-times text-500 hover:text-red-500 cursor-pointer" (click)="removeFile(i)"></i>
            </div>
        </div>

        <div class="flex justify-content-end gap-2">
            <ad-button label="Annulla" severity="secondary" (onClick)="cancelPayslipUpload()"></ad-button>
            <ad-button label="Conferma" [disabled]="payslipFiles.length === 0" (onClick)="confirmUpload()"></ad-button>
        </div>
    </div>
</ad-dialog>

<!-- Template Form Dialog -->
<ad-dialog [(visible)]="showTemplateFormDialog" header="Dati Estratti dalla Busta Paga" [style]="{width: '900px'}">
    <div class="grid formgrid p-fluid" *ngIf="templateFormData?.extractedData">

        <div class="col-12 mt-2 mb-2">
            <h5 class="border-bottom pb-2 text-primary">Riepilogo Economico</h5>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Netto a Pagare"
                [(ngModel)]="templateFormData.extractedData.totali.netto_a_pagare"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Periodo (Mese/Anno)"
                [ngModel]="templateFormData.extractedData.periodo.mese + ' ' + templateFormData.extractedData.periodo.anno"
                (ngModelChange)="null"></ad-input>
        </div>

        <div class="col-12 mt-2 mb-2">
            <h5 class="border-bottom pb-2 text-primary">Anagrafica</h5>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Ragione Sociale Azienda"
                [(ngModel)]="templateFormData.extractedData.anagrafica.azienda"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Codice Fiscale Lavoratore"
                [(ngModel)]="templateFormData.extractedData.anagrafica.cf_dipendente"></ad-input>
        </div>

        <div class="col-12 mt-2 mb-2">
            <h5 class="border-bottom pb-2 text-primary">Inquadramento Contrattuale</h5>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Qualifica" [(ngModel)]="templateFormData.extractedData.inquadramento.qualifica"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Livello" [(ngModel)]="templateFormData.extractedData.inquadramento.livello"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Data Assunzione"
                [(ngModel)]="templateFormData.extractedData.inquadramento.data_assunzione"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="CCNL" [(ngModel)]="templateFormData.extractedData.inquadramento.ccnl_divisione"></ad-input>
        </div>

        <div class="col-12 mt-2 mb-2">
            <h5 class="border-bottom pb-2 text-primary">Contatori (Ferie/Permessi)</h5>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Saldo Ferie"
                [(ngModel)]="templateFormData.extractedData.contatori_ratei.ferie.saldo"></ad-input>
        </div>
        <div class="col-12 md:col-6 field">
            <ad-input label="Saldo ROL/Permessi"
                [(ngModel)]="templateFormData.extractedData.contatori_ratei.permessi_rol.saldo"></ad-input>
        </div>
    </div>

    <div class="col-12 mt-3" *ngIf="templateFormData?.extractedData?.corpo_busta">
        <h5 class="text-primary">Dettaglio Voci (Corpo Busta)</h5>
        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
            <table class="table table-sm table-striped small">
                <thead>
                    <tr>
                        <th>Voce</th>
                        <th>Descrizione</th>
                        <th class="text-end">Competenza</th>
                        <th class="text-end">Trattenuta</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let v of templateFormData.extractedData.corpo_busta">
                        <td>{{v.voce}}</td>
                        <td>{{v.descrizione}}</td>
                        <td class="text-end text-success">{{v.competenza}}</td>
                        <td class="text-end text-danger">{{v.trattenuta}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <ad-button label="Annulla" severity="secondary" (onClick)="showTemplateFormDialog = false"></ad-button>
        <ad-button label="Conferma e Salva" (onClick)="confirmTemplateCreation()"></ad-button>
    </div>
</ad-dialog>